<html>
    <head>
        <script
            type="text/javascript"
            src="../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

namespace Model;

use Service\Db;

class Penggajian
{
    /**
     * simpan class Landa DB ke variabel #db.
     */
    private $db;

    /**
     * variabel untuk menyimpan nama tabel.
     */
    private $table;

    /**
     * konstruktor memanggil library landa Db.
     */
    public function __construct()
    {
        $this-&gt;db = Db::db();
        $this-&gt;table = 'm_komponen_gaji';
        $this-&gt;tablep = 't_payroll';
    }

    /**
     * Ambil semua data penggaajian.
     *
     * @param array  $params
     * @param int    $limit
     * @param int    $offset
     * @param string $order
     */
    public function getIndex($params = [], $limit = 0, $offset = 0, $order = '')
    {
        $this-&gt;db-&gt;select('t_payroll.*, karyawan_data.nama as disetujui_oleh')
            -&gt;from($this-&gt;tablep)
            -&gt;join('left join', 'karyawan', 'karyawan.id = t_payroll.approved_by')
            -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
            -&gt;where('t_payroll.m_perusahaan_id', '=', $_SESSION['user']['m_perusahaan']['id'])
        ;
        // // Filter
        // if (isset($params['filter'])) {
        //     $filter = (array) json_decode($params['filter']);
        //     foreach ($filter as $key =&gt; $val) {
        //         $this-&gt;db-&gt;where($key, 'like', $val);
        //     }
        // }

        // print_r($params);die;
        // filter
        if (isset($params['params']) &amp;&amp; !is_array($params['params'])) {
            // jika parameter dalam bentuk json
            $filter = (isset($params)) ? (array) json_decode($params['params']) : [];
        } elseif (isset($params) &amp;&amp; is_array($params)) {
            $filter = $params;
        }
        // print_r($params);die;
        // set parameter
        if (isset($params['params']) &amp;&amp; !empty($params['params'])) {
            foreach ($filter as $key =&gt; $val) {
                if (!empty($val)) {
                    if ('kode' == $key) {
                        $this-&gt;db-&gt;where('t_payroll.kode', 'like', $val);
                    } elseif ('status' == $key) {
                        $this-&gt;db-&gt;where('t_payroll.status', '=', $val);
                    }
                }
            }
        }

        // Set limit
        if (isset($params['limit']) &amp;&amp; !empty($params['limit'])) {
            $this-&gt;db-&gt;limit($params['limit']);
        }
        // Set offset
        if (isset($params['offset']) &amp;&amp; !empty($params['offset'])) {
            $this-&gt;db-&gt;offset($params['offset']);
        }
        $models = $this-&gt;db-&gt;findAll();
        $totalItem = $this-&gt;db-&gt;count();

        foreach ($models as $key =&gt; $value) {
            $value-&gt;tgl_periode = date('Y-m-d', strtotime($value-&gt;periode_mulai)).' - '.date('Y-m-d', strtotime($value-&gt;periode_selesai));
            $value-&gt;tgl_gajiindex = date('d M Y', strtotime($value-&gt;tgl));
            $value-&gt;tgl_periodeindex = date('d M Y', strtotime($value-&gt;periode_mulai)).' - '.date('d M Y', strtotime($value-&gt;periode_selesai));
            $ambiltotal = $this-&gt;db-&gt;select('t_payroll_det.*, m_komponen_gaji.nama, m_komponen_gaji.is_pokok, SUM((t_payroll_komponen.nilai * m_komponen_gaji.tipe)) as totalambil')
                -&gt;from('t_payroll_det')
                -&gt;join('left join', 't_payroll_komponen', 't_payroll_det.id = t_payroll_komponen.t_payroll_det_id')
                -&gt;join('left join', 'm_komponen_gaji', 'm_komponen_gaji.id = t_payroll_komponen.m_komponen_gaji_id')
                -&gt;where('t_payroll_det.t_payroll_id', '=', $value-&gt;id)
                -&gt;find()
            ;
            $value-&gt;alltotal = $ambiltotal-&gt;totalambil;
            $dibuat = $this-&gt;db-&gt;select('karyawan.nik, karyawan_data.nama as dibuat_oleh')
                -&gt;from('karyawan')
                -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
                -&gt;where('karyawan.id', '=', $value-&gt;created_by)
                -&gt;find()
            ;
            if ($dibuat) {
                $value-&gt;dibuat_oleh = $dibuat-&gt;dibuat_oleh;
            }
            $value-&gt;dibuat_pada = date('d M Y', $value-&gt;created_at);

            $value-&gt;disetujui_oleh = $value-&gt;disetujui_oleh;
            $value-&gt;disetujui_pada = date('d M Y', $value-&gt;approved_at);
        }

        return [
            'data' =&gt; $models,
            'totalItem' =&gt; $totalItem,
        ];
    }

    public function bayarKasbon($payRollId)
    {
        // Ambil data sisa kasbon
        $kasbon = new Kasbon();
        $arrKasbon = $kasbon-&gt;getSisaKasbon();

        // Ambil kasbon yang dibayar waktu penggajian
        $payroll = $this-&gt;db-&gt;select('
                sum(nilai) as bayar, 
                t_payroll_det.karyawan_id,
                t_payroll.tgl,
                t_payroll.id as t_payroll_id
            ')
            -&gt;from('t_payroll_komponen')
            -&gt;leftJoin('t_payroll_det', 't_payroll_det.id = t_payroll_komponen.t_payroll_det_id')
            -&gt;leftJoin('t_payroll', 't_payroll.id = t_payroll_det.t_payroll_id')
            -&gt;where('t_payroll_komponen.m_komponen_gaji_id', '=', 5)
            -&gt;andWhere('t_payroll.id', '=', $payRollId)
            -&gt;andWhere('t_payroll_komponen.nilai', '&gt;', 0)
            -&gt;groupBy('t_payroll_det.karyawan_id')
            -&gt;findAll()
        ;
        foreach ($payroll as $key =&gt; $value) {
            if (isset($arrKasbon[$value-&gt;karyawan_id]) &amp;&amp; !empty($arrKasbon[$value-&gt;karyawan_id])) {
                $totalBayar = $value-&gt;bayar;
                foreach ($arrKasbon[$value-&gt;karyawan_id]['detail'] as $kk =&gt; $vv) {
                    if ($totalBayar &gt; 0) {
                        if ($totalBayar - $vv['sisa'] &lt;= 0) {
                            $bayar = $totalBayar;
                        } else {
                            $bayar = $vv['sisa'];
                        }

                        // simpan pembayaran kasbon
                        // if($vv['sisa'] == $bayar){
                        //     $persen = (($vv['bunga'] + 100) / 100);
                        //     $asliBayar = $bayar / $persen;
                        //     $bungaBayar = $bayar - $asliBayar;
                        // }else{
                        //     $bungaBayar = (($bayar * $vv['bunga']) / 100);
                        //     $asliBayar = $bayar - $bungaBayar;
                        // }

                        $bungaBayar = 0;
                        $asliBayar = $bayar;

                        $arr['t_kasbon_id'] = $vv['t_kasbon_id'];
                        $arr['bayar'] = $asliBayar;
                        $arr['bunga'] = $bungaBayar;
                        $arr['tgl_bayar'] = $value-&gt;tgl;
                        $arr['t_payroll_id'] = $value-&gt;t_payroll_id;

                        $this-&gt;db-&gt;insert('t_kasbon_bayar_det', $arr);

                        if ($totalBayar - $vv['sisa'] &lt;= 0) {
                            $totalBayar = 0;
                        } else {
                            $totalBayar -= $bungaBayar + $asliBayar;
                        }
                    }
                }
            }
        }
    }

    /**
     * Ambil semua data m_komponen_gaji.
     *
     * @param array  $params
     * @param int    $limit
     * @param int    $offset
     * @param string $order
     */
    public function getAll($params = [], $limit = 0, $offset = 0, $order = '')
    {
        $idperusahaan = $_SESSION['user']['m_perusahaan']['id'];
        $modelsP = $this-&gt;db-&gt;select('*')
            -&gt;from($this-&gt;table)
            -&gt;where('is_deleted', '=', 0)
            -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 0
            -&gt;andWhere('is_formula', '=', 0)
            -&gt;customWhere('m_perusahaan_id = &quot;'.$idperusahaan.'&quot; OR is_global = 1', 'AND')
            -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 1
            -&gt;andWhere('is_deleted', '=', 0)
            -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
            -&gt;findAll()
        ;
        $modelsPt = $this-&gt;db-&gt;select('*')
            -&gt;from($this-&gt;table)
            -&gt;where('is_deleted', '=', 0)
            // -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
            -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 0
            -&gt;andWhere('is_formula', '=', 0)
            -&gt;customWhere('m_perusahaan_id ='.$idperusahaan.' OR is_global = 1', 'AND')
            -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 1
            -&gt;andWhere('is_deleted', '=', 0)
            -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
            -&gt;findAll()
        ;

        // $modelsP = $this-&gt;db-&gt;select('*')
        //     -&gt;from($this-&gt;table)
        //     -&gt;where('is_deleted', '=', 0)
        //     -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 0
        //     -&gt;andWhere('is_formula', '=', 0)
        //     -&gt;customWhere('m_perusahaan_id ='.$idperusahaan, 'OR')
        //     -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 1
        //     -&gt;andWhere('is_deleted', '=', 0)
        //     -&gt;findAll();

        // $modelsPt = $this-&gt;db-&gt;select('*')
        //     -&gt;from($this-&gt;table)
        //     -&gt;where('is_deleted', '=', 0)
        //     -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
        //     -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 0
        //     -&gt;andWhere('is_formula', '=', 0)
        //     -&gt;customWhere('m_perusahaan_id ='.$idperusahaan, 'OR')
        //     -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 1
        //     -&gt;andWhere('is_deleted', '=', 0)
        //     -&gt;findAll();

        $karyawan = $this-&gt;db-&gt;select('karyawan.id as idkaryawan, karyawan.no_rekening, karyawan.atas_nama, m_bank.nama as nm_bank, karyawan_data.nama,karyawan.nik, karyawan.status_jht, karyawan.status_jp, karyawan.status_kesehatan, karyawan.status_pph, k_jabatan.m_jabatan_id, m_jabatan.nama as nm_jabatan, m_ptkp.nominal as nominal_ptkp')
            -&gt;from('karyawan')
            -&gt;join('left join', 'k_jabatan', 'k_jabatan.karyawan_id = karyawan.id AND k_jabatan.aktif = 1')
            -&gt;join('left join', 'm_jabatan', 'm_jabatan.id = k_jabatan.m_jabatan_id')
            -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
            -&gt;join('left join', 'm_ptkp', 'm_ptkp.id = karyawan_data.m_ptkp_id')
            -&gt;join('left join', 'm_bank', 'm_bank.id = karyawan.m_bank_id')
            -&gt;where('karyawan.status', '=', 1)
            -&gt;where('karyawan.m_perusahaan_id', '=', $idperusahaan)
            -&gt;andWhere('karyawan.tipe_gaji', '=', $params['tipe'])
            -&gt;findAll()
        ;
        // print_r($karyawan);die;
        $modelsBpjs = [
            '0' =&gt; ['komponen_id' =&gt; '3', 'nama' =&gt; 'jk', 'nilai' =&gt; 0],
            '1' =&gt; ['komponen_id' =&gt; '3', 'nama' =&gt; 'jk_perusahaan', 'nilai' =&gt; 0],
            '2' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jkk_perusahaan', 'nilai' =&gt; 0],
            '3' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jkm_perusahaan', 'nilai' =&gt; 0],
            '4' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jht', 'nilai' =&gt; 0],
            '5' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jht_perusahaan', 'nilai' =&gt; 0],
            '6' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jp', 'nilai' =&gt; 0],
            '7' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jp_perusahaan', 'nilai' =&gt; 0],
        ];

        $bpjsperusahaan = $this-&gt;db-&gt;select('jkk as jkkperusahaan')
            -&gt;from('m_perusahaan')
            -&gt;where('id', '=', $_SESSION['user']['m_perusahaan']['id'])
            -&gt;find()
        ;

        // Ambil lembur karyawan
        $lembur = new Lembur();
        $mulai = isset($params['periode_mulai']) ? date('Y-m-d', strtotime($params['periode_mulai'])) : date('Y-m-d');
        $selesai = isset($params['periode_selesai']) ? date('Y-m-d', strtotime($params['periode_selesai'])) : date('Y-m-d');
        $arrLembur = $lembur-&gt;getLemburByPeriode($mulai, $selesai);

        // Ambil kasbon karyawan
        $kasbon = new Kasbon();
        $arrKasbon = $kasbon-&gt;getSisaKasbon();

        // print_r($bpjsperusahaan);die;
        $arr_data = [];
        $arr_karyawan = [];
        $arr_pendapatan = [];
        $arr_potongan = [];
        $arr_bpjs = [];

        foreach ($karyawan as $key =&gt; $value) {
            $value-&gt;jkkperusahaan = $bpjsperusahaan-&gt;jkkperusahaan;
            $value-&gt;keterangan = '';
            $value-&gt;totaldapat = 0;
            $value-&gt;jkkperusahaan = $bpjsperusahaan-&gt;jkkperusahaan;
            $value-&gt;totaldapat = 0;
            $value-&gt;totalpotong = 0;
            $value-&gt;totalbpjsketenagakerjaan = 0;
            $value-&gt;totalbpjsketenagakerjaan_perusahaan = 0;
            $value-&gt;totalbpjskesehatan = 0;
            $value-&gt;totalbpjskesehatan_perusahaan = 0;
            $value-&gt;pph = 0;
            $value-&gt;takehomepay = 0;
            $value-&gt;sumsemua = 0;
            $arr_karyawan[$key] = (array) $value;
            foreach ($modelsP as $keys =&gt; $vals) {
                if (isset($valz-&gt;nilai) &amp;&amp; '' == $vals-&gt;nilai) {
                    $vals-&gt;nilai = 0;
                } else {
                    $vals-&gt;nilai = 0;
                }
                $vals-&gt;nm_komponen = $vals-&gt;nama;
                $arr_karyawan[$key]['pendapatan'][$keys] = (array) $vals;
            }
            foreach ($modelsPt as $keyz =&gt; $valz) {
                if (isset($valz-&gt;nilai) &amp;&amp; '' == $valz-&gt;nilai) {
                    $valz-&gt;nilai = 0;
                } else {
                    $valz-&gt;nilai = 0;
                }
                $valz-&gt;nm_komponen = $valz-&gt;nama;
                $arr_karyawan[$key]['potongan'][$keyz] = (array) $valz;
            }
            foreach ($modelsBpjs as $keya =&gt; $vala) {
                if (isset($vala['nilai']) &amp;&amp; '' == $vala['nilai']) {
                    $vala['nilai'] = 0;
                } else {
                    $vala['nilai'] = 0;
                }
                $vala['nm_komponen'] = $vala['nama'];
                $arr_karyawan[$key]['bpjs'][$keya] = (array) $vala;
            }
        }
        foreach ($arr_karyawan as $key =&gt; $value) {
            $kasbon = isset($arrKasbon[$value['idkaryawan']]['kasbon']) ? $arrKasbon[$value['idkaryawan']]['kasbon'] : 0;
            $bayar = isset($arrKasbon[$value['idkaryawan']]['bayar']) ? $arrKasbon[$value['idkaryawan']]['bayar'] : 0;

            foreach ($value['pendapatan'] as $keys =&gt; $vals) {
                $cektkomponen = $this-&gt;db-&gt;select('*')
                    -&gt;from('t_komponen_gaji')
                    -&gt;where('karyawan_id', '=', $value['idkaryawan'])
                    -&gt;andWhere('m_komponen_id', '=', $vals['id'])
                    -&gt;find()
                ;
                if (isset($cektkomponen-&gt;karyawan_id) &amp;&amp; !empty($cektkomponen-&gt;karyawan_id)) {
                    $arr_karyawan[$key]['pendapatan'][$keys]['nilai'] = $cektkomponen-&gt;nominal;
                }
                // Ambil nilai lembur
                if (4 == $vals['id']) {
                    $arr_karyawan[$key]['pendapatan'][$keys]['nilai'] = isset($arrLembur[$value['idkaryawan']]) ? $arrLembur[$value['idkaryawan']] : 0;
                }
            }
            foreach ($value['potongan'] as $keyz =&gt; $valz) {
                $cektkomponen = $this-&gt;db-&gt;select('*')
                    -&gt;from('t_komponen_gaji')
                    -&gt;where('karyawan_id', '=', $value['idkaryawan'])
                    -&gt;andWhere('m_komponen_id', '=', $valz['id'])
                    -&gt;find()
                ;
                if (isset($cektkomponen-&gt;karyawan_id) &amp;&amp; !empty($cektkomponen-&gt;karyawan_id)) {
                    $arr_karyawan[$key]['potongan'][$keyz]['nilai'] = $cektkomponen-&gt;nominal;
                }
                // Ambil nilai kasbon
                if (5 == $valz['id'] &amp;&amp; $kasbon - $bayar &gt; 0) {
                    $arr_karyawan[$key]['potongan'][$keyz]['nilai'] = $kasbon - $bayar;
                }
            }
            $arr_karyawan[$key]['kasbon'] = ($kasbon - $bayar &gt; 0) ? $kasbon - $bayar : 0;
            $arr_karyawan[$key]['detailKasbon'] = isset($arrKasbon[$value['idkaryawan']]['detail']) ? $arrKasbon[$value['idkaryawan']]['detail'] : [];
        }

        return [
            'data' =&gt; $arr_karyawan,
            'komponenP' =&gt; $modelsP,
            'komponenPt' =&gt; $modelsPt,
            'komponenBpjs' =&gt; $modelsBpjs,
        ];
    }

    /**
     * Ambil semua data m_komponen_gaji.
     *
     * @param array  $params
     * @param int    $limit
     * @param int    $offset
     * @param string $order
     */
    public function getAllid($params = [])
    {
        $idperusahaan = $_SESSION['user']['m_perusahaan']['id'];
        $models = $this-&gt;db-&gt;select('t_payroll.status, t_payroll_det.id as idtpayrolldet, t_payroll_det.t_payroll_id, t_payroll_det.karyawan_id, t_payroll_det.nominal_ptkp, t_payroll_det.kasbon, t_payroll_det.status_pph, t_payroll_det.tipe, t_payroll_det.keterangan, t_payroll_det.karyawan_id as kid_payroll_det, t_payroll_komponen.id as idpayrollkomponen, t_payroll_komponen.t_payroll_det_id, t_payroll_komponen.m_komponen_gaji_id, t_payroll_komponen.nilai, t_payroll_komponen.tipe, m_komponen_gaji.id as id, m_komponen_gaji.nama as nm_komponen, m_komponen_gaji.is_pokok, karyawan.id as idkaryawan, karyawan.no_rekening, karyawan.atas_nama,m_bank.nama as nm_bank, karyawan_data.nama,karyawan.nik, karyawan.status_jht, karyawan.status_jp, karyawan.status_kesehatan, karyawan.karyawan_data_id as idkaryawandata, karyawan.nik, karyawan_data.nama as nama_karyawan, k_jabatan.m_jabatan_id, m_jabatan.nama as nm_jabatan, t_payroll_bpjs.id as idbpjs_kom, t_payroll_bpjs.jk, t_payroll_bpjs.jk_perusahaan, t_payroll_bpjs.jkk_perusahaan, t_payroll_bpjs.jkm_perusahaan, t_payroll_bpjs.jht, t_payroll_bpjs.jht_perusahaan, t_payroll_bpjs.jp, t_payroll_bpjs.jp_perusahaan')
            -&gt;from('t_payroll_det')
            -&gt;join('left join', 'karyawan', 't_payroll_det.karyawan_id = karyawan.id')
            -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
            -&gt;join('left join', 'k_jabatan', 'k_jabatan.karyawan_id = karyawan.id AND k_jabatan.aktif = 1')
            -&gt;join('left join', 'm_jabatan', 'm_jabatan.id = k_jabatan.m_jabatan_id')
            -&gt;join('left join', 't_payroll_komponen', 't_payroll_det.id = t_payroll_komponen.t_payroll_det_id')
            -&gt;join('left join', 't_payroll_bpjs', 't_payroll_det.id = t_payroll_bpjs.t_payroll_det_id')
            -&gt;join('left join', 'm_komponen_gaji', 'm_komponen_gaji.id = t_payroll_komponen.m_komponen_gaji_id')
            -&gt;join('left join', 't_payroll', 't_payroll.id = t_payroll_det.t_payroll_id')
            -&gt;join('left join', 'm_bank', 'm_bank.id = karyawan.m_bank_id')
            -&gt;where('t_payroll_det.t_payroll_id', '=', $params['id'])
            -&gt;andWhere('karyawan.m_perusahaan_id', '=', $idperusahaan)
            -&gt;customWhere('t_payroll_komponen.m_komponen_gaji_id NOT IN (2,3)', 'AND')
            -&gt;findAll()
        ;
        // print_r($models);die;
        $bpjsperusahaan = $this-&gt;db-&gt;select('jkk as jkkperusahaan')
            -&gt;from('m_perusahaan')
            -&gt;where('id', '=', $_SESSION['user']['m_perusahaan']['id'])
            -&gt;find()
        ;
        $arr_data = [];
        $arr_idkomponen = [];
        foreach ($models as $key =&gt; $value) {
            // print_r($value);die;
            $arr_data[$value-&gt;karyawan_id]['idkaryawan'] = $value-&gt;idkaryawan;
            $arr_data[$value-&gt;karyawan_id]['nik'] = $value-&gt;nik;
            $arr_data[$value-&gt;karyawan_id]['nama'] = $value-&gt;nama_karyawan;
            $arr_data[$value-&gt;karyawan_id]['nama_komponen'] = $value-&gt;nm_komponen;
            $arr_data[$value-&gt;karyawan_id]['nm_jabatan'] = $value-&gt;nm_jabatan;
            $arr_data[$value-&gt;karyawan_id]['status'] = $value-&gt;status;
            if (3 == $value-&gt;status) {
                $arr_idkomponen[$value-&gt;m_komponen_gaji_id] = $value-&gt;m_komponen_gaji_id;
            }
            $arr_data[$value-&gt;karyawan_id]['keterangan'] = $value-&gt;keterangan;
            $arr_data[$value-&gt;karyawan_id]['jkkperusahaan'] = $bpjsperusahaan-&gt;jkkperusahaan;
            $arr_data[$value-&gt;karyawan_id]['kasbon'] = $value-&gt;kasbon;
            $arr_data[$value-&gt;karyawan_id]['no_rekening'] = $value-&gt;no_rekening;
            $arr_data[$value-&gt;karyawan_id]['nm_bank'] = $value-&gt;nm_bank;
            $arr_data[$value-&gt;karyawan_id]['atas_nama'] = $value-&gt;atas_nama;
            $arr_data[$value-&gt;karyawan_id]['status_pph'] = $value-&gt;status_pph;
            $arr_data[$value-&gt;karyawan_id]['totaldapat'] = 0;
            $arr_data[$value-&gt;karyawan_id]['totalpotong'] = 0;
            $arr_data[$value-&gt;karyawan_id]['totalbpjsketenagakerjaan_perusahaan'] = 0;
            $arr_data[$value-&gt;karyawan_id]['totalbpjskesehatan_perusahaan'] = 0;
            $arr_data[$value-&gt;karyawan_id]['nm_jabatan'] = $value-&gt;nm_jabatan;
            $arr_data[$value-&gt;karyawan_id]['nominal_ptkp'] = $value-&gt;nominal_ptkp;
            $arr_data[$value-&gt;karyawan_id]['totaldapat'] = 0;
            $arr_data[$value-&gt;karyawan_id]['totalpotong'] = 0;
            $arr_data[$value-&gt;karyawan_id]['totalbpjsketenagakerjaan'] = 0;
            $arr_data[$value-&gt;karyawan_id]['totalbpjskesehatan'] = 0;
            $arr_data[$value-&gt;karyawan_id]['totalpph'] = 0;
            $arr_data[$value-&gt;karyawan_id]['takehomepay'] = 0;
            $arr_data[$value-&gt;karyawan_id]['sumsemua'] = 0;
            $arr_data[$value-&gt;karyawan_id]['idtpayrolldet'] = $value-&gt;idtpayrolldet;
            $arr_data[$value-&gt;karyawan_id]['idbpjs_kom'] = $value-&gt;idbpjs_kom;
            $arr_data[$value-&gt;karyawan_id]['status_jp'] = $value-&gt;status_jp;
            $arr_data[$value-&gt;karyawan_id]['status_jht'] = $value-&gt;status_jht;
            $arr_data[$value-&gt;karyawan_id]['status_kesehatan'] = $value-&gt;status_kesehatan;

            if (1 == $value-&gt;tipe) {
                $arr_data[$value-&gt;karyawan_id]['pendapatantmp'][$value-&gt;m_komponen_gaji_id] = $value;
            }
            if (2 == $value-&gt;tipe) {
                $arr_data[$value-&gt;karyawan_id]['potongantmp'][$value-&gt;m_komponen_gaji_id] = $value;
            }

            $modelsBpjs = [
                '0' =&gt; ['komponen_id' =&gt; '3', 'nama' =&gt; 'jk', 'nilai' =&gt; $value-&gt;jk],
                '1' =&gt; ['komponen_id' =&gt; '3', 'nama' =&gt; 'jk_perusahaan', 'nilai' =&gt; 0],
                '2' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jkk_perusahaan', 'nilai' =&gt; 0],
                '3' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jkm_perusahaan', 'nilai' =&gt; 0],
                '4' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jht', 'nilai' =&gt; $value-&gt;jht],
                '5' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jht_perusahaan', 'nilai' =&gt; 0],
                '6' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jp', 'nilai' =&gt; $value-&gt;jp],
                '7' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jp_perusahaan', 'nilai' =&gt; 0],
            ];

            $arr_data[$value-&gt;karyawan_id]['bpjs'] = $modelsBpjs;
        }

        // print_r($arr_idkomponen);die;

        $this-&gt;db-&gt;select('*')
            -&gt;from($this-&gt;table)
            -&gt;where('is_deleted', '=', 0)
            -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 0
            -&gt;andWhere('is_formula', '=', 0)
            -&gt;customWhere('m_perusahaan_id ='.$idperusahaan.' OR is_global = 1', 'AND')
            -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 1
            -&gt;andWhere('is_deleted', '=', 0)
        ;

        if (!empty($arr_idkomponen)) {
            $this-&gt;db-&gt;customWhere('id IN ('.implode(',', $arr_idkomponen).')', 'AND');
        }
        $modelsP = $this-&gt;db-&gt;findAll();

        $this-&gt;db-&gt;select('*')
            -&gt;from($this-&gt;table)
            -&gt;where('is_deleted', '=', 0)
            -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
            -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 0
            -&gt;andWhere('is_formula', '=', 0)
            -&gt;customWhere('m_perusahaan_id ='.$idperusahaan.' OR is_global = 1', 'AND')
            -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 1
            -&gt;andWhere('is_deleted', '=', 0)
        ;

        if (!empty($arr_idkomponen)) {
            $this-&gt;db-&gt;customWhere('id IN ('.implode(',', $arr_idkomponen).')', 'AND');
        }
        $modelsPt = $this-&gt;db-&gt;findAll();

        $addkg = [];
        foreach ($arr_data as $key =&gt; $value) {
            foreach ($modelsP as $keys =&gt; $vals) {
                $addkg['nilai'] = 0;
                $addkg['m_komponen_gaji_id'] = $vals-&gt;id;
                $addkg['t_payroll_det_id'] = $value['idtpayrolldet'];
                $arr_data[$key]['pendapatan'][] = isset($arr_data[$key]['pendapatantmp'][$vals-&gt;id]) ? $arr_data[$key]['pendapatantmp'][$vals-&gt;id] : $addkg;
            }

            foreach ($modelsPt as $keya =&gt; $vala) {
                $addkg['nilai'] = 0;
                $addkg['m_komponen_gaji_id'] = $vala-&gt;id;
                $addkg['t_payroll_det_id'] = $value['idtpayrolldet'];
                $arr_data[$key]['potongan'][] = isset($arr_data[$key]['potongantmp'][$vala-&gt;id]) ? $arr_data[$key]['potongantmp'][$vala-&gt;id] : $addkg;
            }

            unset($arr_data[$key]['pendapatantmp'], $arr_data[$key]['potongantmp']);
        }
        $arr = [];
        $i = 0;
        foreach ($arr_data as $keys =&gt; $value) {
            $arr[$i] = $value;
            ++$i;
        }
        // print_r($arr);die;
        return [
            'data' =&gt; $arr,
            'komponenP' =&gt; $modelsP,
            'komponenPt' =&gt; $modelsPt,
            'komponenBpjs' =&gt; $modelsBpjs,
        ];
    }

    /**
     * Ambil semua data m_komponen_gaji.
     *
     * @param array  $params
     * @param int    $limit
     * @param int    $offset
     * @param string $order
     */
    public function getKarid($params = [])
    {
        $models = $this-&gt;db-&gt;select('t_payroll.id as idpayroll, t_payroll.kode, t_payroll.tgl, t_payroll.periode_mulai, t_payroll.periode_selesai, t_payroll.status, t_payroll_det.*, t_payroll_det.karyawan_id as kid_payroll_det, t_payroll_komponen.*, m_komponen_gaji.nama, m_komponen_gaji.is_pokok, karyawan.id as idkaryawan, karyawan_data.nama as nama_karyawan, karyawan.nik,  
            SUM((t_payroll_komponen.nilai * m_komponen_gaji.tipe)) as pendapatan')
            -&gt;from('t_payroll')
            -&gt;join('left join', 't_payroll_det', 't_payroll_det.t_payroll_id = t_payroll.id')
            -&gt;join('left join', 'karyawan', 't_payroll_det.karyawan_id = karyawan.id')
            -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
            -&gt;join('left join', 't_payroll_komponen', 't_payroll_det.id = t_payroll_komponen.t_payroll_det_id')
            -&gt;join('left join', 'm_komponen_gaji', 'm_komponen_gaji.id = t_payroll_komponen.m_komponen_gaji_id')
            -&gt;where('t_payroll_det.karyawan_id', '=', $params['idkaryawan'])
            -&gt;andWhere('t_payroll.status', '=', 3)
            -&gt;groupBy('t_payroll_komponen.t_payroll_det_id')
            -&gt;findAll()
        ;

        $arr_data = [];
        foreach ($models as $key =&gt; $value) {
            $arr_data[$value-&gt;id]['idpayroll'] = $value-&gt;idpayroll;
            $arr_data[$value-&gt;id]['kode'] = $value-&gt;kode;
            $arr_data[$value-&gt;id]['status'] = $value-&gt;status;
            $arr_data[$value-&gt;id]['tanggal'] = date('d M Y', strtotime($value-&gt;tgl));
            $arr_data[$value-&gt;id]['periode'] = date('d M Y', strtotime($value-&gt;periode_mulai)).' s/d '.date('d M Y', strtotime($value-&gt;periode_selesai));
            $arr_data[$value-&gt;id]['idkaryawan'] = $value-&gt;idkaryawan;
            $arr_data[$value-&gt;id]['nikkaryawan'] = $value-&gt;nik;
            $arr_data[$value-&gt;id]['pendapatan'] = number_format($value-&gt;pendapatan);
        }

        $arr = [];
        $i = 0;
        foreach ($arr_data as $keys =&gt; $value) {
            $arr[$i] = $value;
            ++$i;
        }

        return [
            'data' =&gt; $arr,
        ];
    }

    public function getPreview($data)
    {
        // print_r($data);die;
        $arr_data = [];
        foreach ($data as $key =&gt; $value) {
            $arr_data[$key]['idkaryawan'] = $value['idkaryawan'];
            $arr_data[$key]['nik'] = $value['nik'];
            $arr_data[$key]['nama'] = $value['nama'];
            $arr_data[$key]['m_jabatan_id'] = $value['m_jabatan_id'];
            $arr_data[$key]['nm_jabatan'] = $value['nm_jabatan'];
            $arr_data[$key]['jumlahgjpokok'] = $value['jumlahgjpokok'];
            $arr_data[$key]['jkkperusahaan'] = $value['jkkperusahaan'];
            $arr_data[$key]['status_jht'] = $value['status_jht'];
            $arr_data[$key]['status_jp'] = $value['status_jp'];
            $arr_data[$key]['status_kesehatan'] = $value['status_kesehatan'];

            $sumdapat = 0;
            foreach ($value['pendapatan'] as $keys =&gt; $val) {
                $sumdapat += $val['nilai'];
                $arr_data[$key]['pendapatan'][] = $val;
                $arr_data[$key]['totaldapat'] = $sumdapat;
            }

            $sumpotong = 0;
            foreach ($value['potongan'] as $keys =&gt; $val) {
                $sumpotong += $val['nilai'];
                $arr_data[$key]['potongan'][] = $val;
                $arr_data[$key]['totalpotong'] = $sumpotong;
            }

            // $sumbpjs = 0;
            foreach ($value['bpjs'] as $keys =&gt; $val) {
                // print_r($value['jumlahgjpokok']);die;
                if ('jk' == $val['nama']) {
                    $jk = $val['nilai'];
                } elseif ('jkk_perusahaan' == $val['nama']) {
                    // $val['nilai'] = $value['jumlahgjpokok'] * $value['jkkperusahaan'] / 100;
                } elseif ('jkm_perusahaan' == $val['nama']) {
                    // $val['nilai'] = $value['jumlahgjpokok'] * 0.30 / 100;
                } elseif ('jht' == $val['nama']) {
                    $jht = $val['nilai'];
                } elseif ('jp' == $val['nama']) {
                    $jp = $val['nilai'];
                }
                // print_r($val);die;
                $arr_data[$key]['bpjs'][] = $val;
                $sumbpjskt = $jht + $jp;
                $sumbpjsks = $jk;
                $arr_data[$key]['totalbpjsketenagakerjaan'] = $sumbpjskt;
                $arr_data[$key]['totalbpjskesehatan'] = $sumbpjsks;
            }
            if (isset($value['pph'])) {
                $arr_data[$key]['pph'] = $value['pph'];
            } else {
                $arr_data[$key]['pph'] = 0;
            }
            // if (isset($value['pph']) &amp;&amp; $value['pph'] != 0) {
            //     $arr_data[$key]['pph'] = $value['pph'];
            //     $arr_data[$key]['takehomepay'] = $arr_data[$key]['totaldapat'] - $arr_data[$key]['totalpotong'] - $arr_data[$key]['totalbpjsketenagakerjaan'] - $arr_data[$key]['totalbpjskesehatan'] - $arr_data[$key]['pph'];
            // }else{
            $arr_data[$key]['takehomepay'] = $arr_data[$key]['totaldapat'] - $arr_data[$key]['totalpotong'] - $arr_data[$key]['totalbpjsketenagakerjaan'] - $arr_data[$key]['totalbpjskesehatan'] - $arr_data[$key]['pph'];
            $arr_data[$key]['sumsemua'] = $arr_data[$key]['totaldapat'] - $arr_data[$key]['totalpotong'] - $arr_data[$key]['totalbpjsketenagakerjaan'] - $arr_data[$key]['totalbpjskesehatan'] - $arr_data[$key]['pph'];
            // }
        }
        // print_r($arr_data);die;
        return [
            'data' =&gt; $arr_data,
        ];
    }

    /**
     * Validasi data yang dikirim.
     *
     * @param array $data
     * @param array $custom
     */
    public function validasi($data, $custom = [])
    {
        $validasi = [
            'tgl_gaji' =&gt; 'required',
        ];
        \GUMP::set_field_name('tgl_gaji', 'Tanggal');

        return validate($data, $validasi, $custom);
    }

    public function changestatus($data, $customParams = '')
    {
        try {
            if (3 == $data['status']) {
                $data['status'] = $data['status'];
                $data['approved_at'] = strtotime(date('Y-m-d'));
                $data['approved_by'] = $_SESSION['user']['userId'];
                $model = $this-&gt;db-&gt;update('t_payroll', $data, ['id' =&gt; $data['model']['id']]);
            } else {
                $data['status'] = $data['status'];
                $model = $this-&gt;db-&gt;update('t_payroll', $data, ['id' =&gt; $data['model']['id']]);
            }

            // Jika penggajian diapprove simpan pembayaran kasbon
            if (3 == $model-&gt;status) {
                $this-&gt;bayarKasbon($model-&gt;id);
            }

            if ($model) {
                return [
                    'status' =&gt; true,
                    'data' =&gt; $model,
                ];
            }
        } catch (Exception $e) {
            return [
                'status' =&gt; false,
                'error' =&gt; $e-&gt;getMessage(),
            ];
        }
    }

    /**
     * Method untuk menyimpan data payroll.
     *
     * @param array $data
     * @param array $customParams
     */
    public function save($data, $customParams = '')
    {
        //INISIALISASI TABEL T_PAYROL
        // print_r($data);die;
        $input1 = [];
        $input1['m_perusahaan_id'] = $_SESSION['user']['m_perusahaan']['id'];
        if (isset($data['form']['tgl_gaji'])) {
            $input1['tgl'] = implode('-', $data['form']['tgl_gaji']);
            $month = $data['form']['tgl_gaji']['month'];
            if (strlen($month) &gt; 1) {
                $monthkode = $month;
            } else {
                $monthkode = '0'.$month;
            }
            $yearkode = substr($data['form']['tgl_gaji']['year'], 2);
        }
        if (isset($data['form']['tgl_periode'])) {
            $input1['periode_mulai'] = substr($data['form']['tgl_periode'], 0, 10);
            $input1['periode_selesai'] = substr($data['form']['tgl_periode'], 12, 16);
        }
        if (isset($data['periode_mulai']) &amp;&amp; !empty($data['periode_mulai'])) {
            $input1['periode_mulai'] = date('Y-m-d', strtotime($data['periode_mulai'].' +1 day'));
            $input1['periode_selesai'] = date('Y-m-d', strtotime($data['periode_selesai']));
        }
        $input1['tipe'] = isset($data['form']['tipe']) ? $data['form']['tipe'] : '';
        $input1['status'] = isset($data['is_draft']) ? $data['is_draft'] : '';
        // print_r($input1);die;
        try {
            if (isset($data['form']['id']) &amp;&amp; '' != $data['form']['id']) {
                // print_r($input1);die;

                // exit;
                $this-&gt;db-&gt;startTransaction();
                $model = $this-&gt;db-&gt;update($this-&gt;tablep, $input1, ['id' =&gt; $data['form']['id']]);

                // $input2 = [];
                $input3 = [];
                $input4 = [];
                $input5 = [];
                // print_r($data);die;
                foreach ($data['model'] as $key =&gt; $value) {
                    // print_r($value);die;
                    // $input2['t_payroll_id'] = $model-&gt;id;
                    if (isset($value['idtpayrolldet']) &amp;&amp; !empty($value['idtpayrolldet'])) {
                        $input2['keterangan'] = $value['keterangan'];
                        $t_payroll_det_ngedit = $this-&gt;db-&gt;update('t_payroll_det', $input2, ['id' =&gt; $value['idtpayrolldet']]);
                    } else {
                        $input2['t_payroll_id'] = $model-&gt;id;
                        $input2['karyawan_id'] = $value['idkaryawan'];
                        $input2['nominal_ptkp'] = $value['nominal_ptkp'];
                        $input2['keterangan'] = $value['keterangan'];
                        $input2['kasbon'] = $value['kasbon'];
                        $input2['status_pph'] = $value['status_pph'];
                        $t_payroll_det_nambah = $this-&gt;db-&gt;insert('t_payroll_det', $input2);
                    }

                    if ($t_payroll_det_ngedit) {
                        // print_r($value);die;
                        if (isset($value['pendapatan']) &amp;&amp; !empty($value['pendapatan'])) {
                            foreach ($value['pendapatan'] as $keys =&gt; $val) {
                                if (isset($val['idpayrollkomponen']) &amp;&amp; !empty($val['idpayrollkomponen'])) {
                                    $input3['nilai'] = $val['nilai'];
                                    $input3['tipe'] = 1;
                                    $input3['m_komponen_gaji_id'] = $val['m_komponen_gaji_id'];
                                    $input3['t_payroll_det_id'] = $val['t_payroll_det_id'];
                                    $t_payroll_komponen = $this-&gt;db-&gt;update('t_payroll_komponen', $input3, ['id' =&gt; $val['idpayrollkomponen']]);
                                }
                                // else {
                                //     $input3['nilai'] = $val['nilai'];
                                //     $input3['tipe'] = 1;
                                //     $input3['m_komponen_gaji_id'] = $val['m_komponen_gaji_id'];
                                //     $input3['t_payroll_det_id'] = $val['t_payroll_det_id'];
                                //     $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input3);
                                // }
                                unset($input3);
                            }
                            // die;
                        }
                        if (isset($value['potongan']) &amp;&amp; !empty($value['potongan'])) {
                            foreach ($value['potongan'] as $keys =&gt; $val) {
                                if (isset($val['idpayrollkomponen']) &amp;&amp; !empty($val['idpayrollkomponen'])) {
                                    $input4['nilai'] = $val['nilai'];
                                    $input4['tipe'] = 2;
                                    $input4['m_komponen_gaji_id'] = $val['m_komponen_gaji_id'];
                                    $input4['t_payroll_det_id'] = $val['t_payroll_det_id'];
                                    $t_payroll_komponen = $this-&gt;db-&gt;update('t_payroll_komponen', $input4, ['id' =&gt; $val['idpayrollkomponen']]);
                                }
                                // else {
                                //     $input4['nilai'] = $val['nilai'];
                                //     $input4['tipe'] = 2;
                                //     $input4['m_komponen_gaji_id'] = $val['m_komponen_gaji_id'];
                                //     $input4['t_payroll_det_id'] = $val['t_payroll_det_id'];
                                //     $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input4);
                                // }
                                unset($input4);
                            }
                        }
                        if (isset($value['bpjs']) &amp;&amp; !empty($value['bpjs'])) {
                            foreach ($value['bpjs'] as $keys =&gt; $val) {
                                $input5[$val['nama']] = $val['nilai'];
                                // if ('JK' == $val['nama']) {
                                //     $input5['jk'] = $val['nilai'];
                                // } elseif ('JKK' == $val['nama']) {
                                //     $input5['jkk'] = $val['nilai'];
                                // } elseif ('JKM' == $val['nama']) {
                                //     $input5['jkm'] = $val['nilai'];
                                // } elseif ('JHT' == $val['nama']) {
                                //     $input5['jht'] = $val['nilai'];
                                // } elseif ('JP' == $val['nama']) {
                                //     $input5['jp'] = $val['nilai'];
                                // }
                            }
                            // print_r($input5);die;
                            $t_payroll_komponen = $this-&gt;db-&gt;update('t_payroll_bpjs', $input5, ['id' =&gt; $value['idbpjs_kom']]);
                        }
                        // print_r($value);die;
                        if (isset($value['totalbpjsketenagakerjaan']) &amp;&amp; !empty($value['totalbpjsketenagakerjaan'])) {
                            // print_r($val);die;
                            $cekbpjsketenagakerjaan = $this-&gt;db-&gt;select('id')
                                -&gt;from('t_payroll_komponen')
                                -&gt;where('t_payroll_det_id', '=', $value['idtpayrolldet'])
                                -&gt;andWhere('m_komponen_gaji_id', '=', 2)
                                -&gt;find()
                            ;

                            $input6['nilai'] = $value['totalbpjsketenagakerjaan'];
                            $input6['tipe'] = 2;

                            $t_payroll_komponen = $this-&gt;db-&gt;update('t_payroll_komponen', $input6, ['id' =&gt; $cekbpjsketenagakerjaan-&gt;id]);
                        }
                        if (isset($value['totalbpjskesehatan']) &amp;&amp; !empty($value['totalbpjskesehatan'])) {
                            $cekbpjskesehatan = $this-&gt;db-&gt;select('id')
                                -&gt;from('t_payroll_komponen')
                                -&gt;where('t_payroll_det_id', '=', $value['idtpayrolldet'])
                                -&gt;andWhere('m_komponen_gaji_id', '=', 3)
                                -&gt;find()
                            ;
                            // print_r($cekbpjskesehatan);die;
                            $input7['nilai'] = $value['totalbpjskesehatan'];
                            $input7['tipe'] = 2;

                            $t_payroll_komponen = $this-&gt;db-&gt;update('t_payroll_komponen', $input7, ['id' =&gt; $cekbpjskesehatan-&gt;id]);
                        }
                        if (isset($value['totalpph']) &amp;&amp; !empty($value['totalpph'])) {
                            $cekpph = $this-&gt;db-&gt;select('id')
                                -&gt;from('t_payroll_komponen')
                                -&gt;where('t_payroll_det_id', '=', $value['idtpayrolldet'])
                                -&gt;andWhere('m_komponen_gaji_id', '=', 6)
                                -&gt;find()
                            ;

                            $input8['nilai'] = $value['totalpph'];
                            $input8['tipe'] = 3;

                            $t_payroll_komponen = $this-&gt;db-&gt;update('t_payroll_komponen', $input8, ['id' =&gt; $cekpph-&gt;id]);
                        }
                    }
                    if ($t_payroll_det_nambah) {
                        if (isset($value['pendapatan']) &amp;&amp; !empty($value['pendapatan'])) {
                            foreach ($value['pendapatan'] as $keys =&gt; $val) {
                                $input3['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                                $input3['m_komponen_gaji_id'] = $val['id'];
                                $input3['nilai'] = $val['nilai'];
                                $input3['tipe'] = 1;
                                $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input3);
                            }
                        }
                        if (isset($value['potongan']) &amp;&amp; !empty($value['potongan'])) {
                            foreach ($value['potongan'] as $keys =&gt; $val) {
                                $input4['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                                $input4['m_komponen_gaji_id'] = $val['id'];
                                $input4['nilai'] = $val['nilai'];
                                $input4['tipe'] = 2;
                                $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input4);
                            }
                        }
                        if (isset($value['totalbpjsketenagakerjaan']) &amp;&amp; !empty($value['totalbpjsketenagakerjaan'])) {
                            $input6['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                            $input6['m_komponen_gaji_id'] = 2;
                            $input6['nilai'] = $value['totalbpjsketenagakerjaan'];
                            $input6['tipe'] = 2;

                            $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input6);
                            if (isset($value['bpjs']) &amp;&amp; !empty($value['bpjs'])) {
                                foreach ($value['bpjs'] as $keys =&gt; $val) {
                                    $input5['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                                    $input5['t_payroll_komponen_id'] = $t_payroll_komponen-&gt;id;
                                    $input5[$val['nama']] = $val['nilai'];
                                }
                                $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_bpjs', $input5);
                            }
                        }
                        if (isset($value['totalbpjskesehatan']) &amp;&amp; !empty($value['totalbpjskesehatan'])) {
                            $input7['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                            $input7['m_komponen_gaji_id'] = 3;
                            $input7['nilai'] = $value['totalbpjskesehatan'];
                            $input7['tipe'] = 2;

                            $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input7);
                        }
                        if (isset($value['totalpph']) &amp;&amp; !empty($value['totalpph'])) {
                            $input8['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                            $input8['m_komponen_gaji_id'] = 6;
                            $input8['nilai'] = $value['totalpph'];
                            $input8['tipe'] = 3;

                            $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input8);
                        }
                    }
                }
                $this-&gt;db-&gt;endTransaction();
            } else {
                $this-&gt;db-&gt;startTransaction();
                $input1['kode'] = generate_kodegaji($yearkode, $monthkode);
                $model = $this-&gt;db-&gt;insert('t_payroll', $input1);

                $input2 = [];
                $input3 = [];
                $input4 = [];
                $input5 = [];
                $input6 = [];
                $input7 = [];
                $input8 = [];
                // print_r($data['model']);die;
                foreach ($data['model'] as $key =&gt; $value) {
                    $input2['t_payroll_id'] = $model-&gt;id;
                    $input2['karyawan_id'] = $value['idkaryawan'];
                    $input2['nominal_ptkp'] = $value['nominal_ptkp'];
                    $input2['keterangan'] = $value['keterangan'];
                    $input2['kasbon'] = $value['kasbon'];
                    $input2['status_pph'] = $value['status_pph'];
                    $t_payroll_det_nambah = $this-&gt;db-&gt;insert('t_payroll_det', $input2);

                    if ($t_payroll_det_nambah) {
                        if (isset($value['pendapatan']) &amp;&amp; !empty($value['pendapatan'])) {
                            foreach ($value['pendapatan'] as $keys =&gt; $val) {
                                $input3['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                                $input3['m_komponen_gaji_id'] = $val['id'];
                                $input3['nilai'] = $val['nilai'];
                                $input3['tipe'] = 1;

                                $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input3);
                            }
                        }
                        if (isset($value['potongan']) &amp;&amp; !empty($value['potongan'])) {
                            foreach ($value['potongan'] as $keys =&gt; $val) {
                                $input4['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                                $input4['m_komponen_gaji_id'] = $val['id'];
                                $input4['nilai'] = $val['nilai'];
                                $input4['tipe'] = 2;

                                $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input4);
                            }
                        }
                        if (isset($value['totalbpjsketenagakerjaan']) &amp;&amp; !empty($value['totalbpjsketenagakerjaan'])) {
                            $input6['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                            $input6['m_komponen_gaji_id'] = 2;
                            $input6['nilai'] = $value['totalbpjsketenagakerjaan'];
                            $input6['tipe'] = 2;

                            $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input6);
                            if (isset($value['bpjs']) &amp;&amp; !empty($value['bpjs'])) {
                                foreach ($value['bpjs'] as $keys =&gt; $val) {
                                    $input5['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                                    $input5['t_payroll_komponen_id'] = $t_payroll_komponen-&gt;id;
                                    $input5[$val['nama']] = $val['nilai'];
                                }
                                $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_bpjs', $input5);
                            }
                        }
                        if (isset($value['totalbpjskesehatan']) &amp;&amp; !empty($value['totalbpjskesehatan'])) {
                            $input7['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                            $input7['m_komponen_gaji_id'] = 3;
                            $input7['nilai'] = $value['totalbpjskesehatan'];
                            $input7['tipe'] = 2;

                            $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input7);
                        }
                        if (isset($value['totalpph']) &amp;&amp; !empty($value['totalpph'])) {
                            $input8['t_payroll_det_id'] = $t_payroll_det_nambah-&gt;id;
                            $input8['m_komponen_gaji_id'] = 6;
                            $input8['nilai'] = $value['totalpph'];
                            $input8['tipe'] = 3;

                            $t_payroll_komponen = $this-&gt;db-&gt;insert('t_payroll_komponen', $input8);
                        }
                    }
                }

                $this-&gt;db-&gt;endTransaction();
            }
            // Return data payroll
            return [
                'status' =&gt; true,
                'data' =&gt; $model,
            ];
        } catch (Exception $e) {
            return [
                'status' =&gt; false,
                'error' =&gt; $e-&gt;getMessage(),
            ];
        }
    }

    public function delete($params)
    {
        try {
            $this-&gt;db-&gt;startTransaction();
            $model = $this-&gt;db-&gt;delete('t_payroll', ['id' =&gt; $params['id']]);
            $payrolldet = $this-&gt;db-&gt;select('id')-&gt;from('t_payroll_det')-&gt;where('t_payroll_id', '=', $params['id'])-&gt;findAll();
            foreach ($payrolldet as $key =&gt; $value) {
                $komponen = $this-&gt;db-&gt;delete('t_payroll_komponen', ['t_payroll_det_id' =&gt; $value-&gt;id]);
                $komponenbpjs = $this-&gt;db-&gt;delete('t_payroll_bpjs', ['t_payroll_det_id' =&gt; $value-&gt;id]);
            }
            $models = $this-&gt;db-&gt;delete('t_payroll_det', ['t_payroll_id' =&gt; $params['id']]);
            $this-&gt;db-&gt;endTransaction();
            // Return data payroll
            return [
                'status' =&gt; true,
                'data' =&gt; $model,
            ];
        } catch (Exception $e) {
            return [
                'status' =&gt; false,
                'error' =&gt; $e-&gt;getMessage(),
            ];
        }
    }

    public function deletedetail($params)
    {
        try {
            $this-&gt;db-&gt;startTransaction();

            $komponen = $this-&gt;db-&gt;delete('t_payroll_komponen', ['t_payroll_det_id' =&gt; $params['id']]);
            $komponenbpjs = $this-&gt;db-&gt;delete('t_payroll_bpjs', ['t_payroll_det_id' =&gt; $params['id']]);
            $models = $this-&gt;db-&gt;delete('t_payroll_det', ['t_payroll_id' =&gt; $params['id']]);

            $this-&gt;db-&gt;endTransaction();
            // Return data payroll
            return [
                'status' =&gt; true,
                'data' =&gt; $model,
            ];
        } catch (Exception $e) {
            return [
                'status' =&gt; false,
                'error' =&gt; $e-&gt;getMessage(),
            ];
        }
    }

    /**
     * Ambil semua data Slip Gaji.
     *
     * @param array  $params
     * @param int    $limit
     * @param int    $offset
     * @param string $order
     */
    public function getSlipgaji($params = [])
    {
        if (isset($params['parampreview']) &amp;&amp; !empty($params['parampreview'])) {
            // print_r($params['model']);die;
            $arr_data = [];
            $perusahaan = $this-&gt;db-&gt;select('*')-&gt;from('m_perusahaan')-&gt;where('id', '=', $_SESSION['user']['m_perusahaan']['id'])-&gt;find();
            $karyawan = $this-&gt;db-&gt;select('*')
                -&gt;from('karyawan_data')
                -&gt;join('left join', 'karyawan', 'karyawan.karyawan_data_id = karyawan_data.id')
                -&gt;where('karyawan.id', '=', $params['model']['idkaryawan'])
                -&gt;find()
            ;

            // print_r($karyawan);die;
            $arr_data[$params['model']['idkaryawan']]['gaji_kode'] = $params['model']['kode'];
            // $arr_data[$params['model']['idkaryawan']]['gaji_tgl_gaji'] = date('F, Y', strtotime($value-&gt;tgl_gaji));
            // $arr_data[$params['model']['idkaryawan']]['gaji_periode_mulai'] = date('d F, Y', strtotime($value-&gt;periode_mulai));
            // $arr_data[$params['model']['idkaryawan']]['gaji_periode_selesai'] = date('d F, Y', strtotime($value-&gt;periode_selesai));
            // $arr_data[$params['model']['idkaryawan']]['gaji_keterangan'] = $value-&gt;keterangan;
            $arr_data[$params['model']['idkaryawan']]['perusahaan_nama'] = $perusahaan-&gt;nama;
            $arr_data[$params['model']['idkaryawan']]['perusahaan_alamat'] = $perusahaan-&gt;alamat;
            $arr_data[$params['model']['idkaryawan']]['perusahaan_telepon'] = $perusahaan-&gt;telepon;
            $arr_data[$params['model']['idkaryawan']]['karyawan_nik'] = $params['model']['nik'];
            $arr_data[$params['model']['idkaryawan']]['karyawan_nama'] = $karyawan-&gt;nama;
            // $arr_data[$params['model']['idkaryawan']]['karyawan_alamat'] = $karyawan-&gt;alamat_karyawan.', '.$karyawan-&gt;provinsi.', '.$karyawan-&gt;kota.', '.$karyawan-&gt;kecamatan.', '.$karyawan-&gt;desa.', '.$karyawan-&gt;kode_pos;
            $arr_data[$params['model']['idkaryawan']]['karyawan_telepon'] = $karyawan-&gt;no_hp;
            $arr_data[$params['model']['idkaryawan']]['karyawan_email'] = $karyawan-&gt;email;
            $arr_data[$params['model']['idkaryawan']]['karyawan_npwp'] = $karyawan-&gt;no_npwp;
            $arr_data[$params['model']['idkaryawan']]['karyawan_jabatan'] = $params['model']['nm_jabatan'];
            $arr_data[$params['model']['idkaryawan']]['nm_bank'] = $params['model']['nm_bank'];
            $arr_data[$params['model']['idkaryawan']]['no_rekening'] = $params['model']['no_rekening'];
            $arr_data[$params['model']['idkaryawan']]['nm_anbank'] = $params['model']['atas_nama'];
            $arr_data[$params['model']['idkaryawan']]['kasbon'] = $params['model']['kasbon'];
            $ardapat = [];
            foreach ($params['model']['pendapatan'] as $key =&gt; $value) {
                unset($value['nama']);
                $value['nama'] = $value['nm_komponen'];
                $arrdapat[$key] = $value;
            }
            $arrpotong = [];
            foreach ($params['model']['potongan'] as $key =&gt; $value) {
                unset($value['nama']);
                $value['nama'] = $value['nm_komponen'];
                $arrpotong[$key] = $value;
            }

            $arrbpjss = [];
            foreach ($params['model']['bpjs'] as $key =&gt; $value) {
                unset($value['nama']);
                $value['nama'] = $value['nm_komponen'];
                $arrbpjss[$key] = $value;
            }

            $arr_data[$params['model']['idkaryawan']]['pendapatan'] = $arrdapat;
            $arr_data[$params['model']['idkaryawan']]['potongan'] = $arrpotong;
            $arr_data[$params['model']['idkaryawan']]['pph'] = $params['model']['pendapatan']['totalpph'];

            foreach ($arr_data as $key =&gt; $value) {
                // print_r($value);die;
                $sumdapat = 0;
                foreach ($value['pendapatan'] as $keys =&gt; $val) {
                    $val['nomor'] = $keys + 1;
                    $sumdapat += $val['nilai'];
                    $arr_data[$key]['totaldapat'] = $sumdapat;
                }

                $sumpotong = 0;
                foreach ($value['potongan'] as $keys =&gt; $val) {
                    $val['nomor'] = $keys + 1;
                    $sumpotong += $val['nilai'];
                    $arr_data[$key]['totalpotong'] = $sumpotong;

                    if (5 == $val-&gt;m_komponen_gaji_id) {
                        $arr_data[$key]['bayarkasbon'] = $val['nilai'];
                    }
                }
            }
            foreach ($arr_data as $key =&gt; $value) {
                $arr_data[$key]['takehomepay'] = $value['totaldapat'] - $value['totalpotong'] - $value['pph'];
                $arr_data[$key]['sisakasbon'] = $value['kasbon'] - $value['bayarkasbon'];
            }
        } else {
            // $idperusahaan = $_SESSION['user']['m_perusahaan']['id'];
            $this-&gt;db-&gt;select('t_payroll.kode, t_payroll.tgl as tgl_gaji, t_payroll.periode_mulai, t_payroll.periode_selesai, t_payroll_det.*, t_payroll_det.karyawan_id as kid_payroll_det, t_payroll_komponen.*, m_komponen_gaji.nama, m_komponen_gaji.is_pokok, karyawan_data.nama as nama_karyawan, karyawan.nik, karyawan.m_bank_id, karyawan.no_rekening, karyawan.atas_nama as nm_anbank, m_bank.nama as nm_bank, karyawan_data.alamat_detail as alamat_karyawan, karyawan_data.kode_pos, karyawan_data.no_hp as no_hp_karyawan, karyawan_data.email, karyawan_data.no_npwp, m_perusahaan.nama as nama_perusahaan, m_perusahaan.alamat as alamat_perusahaan, m_perusahaan.telepon as telepon_perusahaan, k_jabatan.m_jabatan_id, m_jabatan.nama as nm_jabatan_karyawan,w_provinsi.provinsi, w_kota.kota, w_kecamatan.kecamatan, w_desa.desa, w_provinsi.provinsi as prov_perusahaan, w_kota.kota as kota_perusahaan, w_kecamatan.kecamatan as kec_perusahaan, w_desa.desa as desa_perusahaan, m_perusahaan.w_provinsi_id as idprov')
                -&gt;from('t_payroll')
                -&gt;join('left join', 't_payroll_det', 't_payroll_det.t_payroll_id = t_payroll.id')
                -&gt;join('left join', 'karyawan', 't_payroll_det.karyawan_id = karyawan.id')
                -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
                -&gt;join('left join', 'k_jabatan', 'k_jabatan.karyawan_id = karyawan_data.id')
                -&gt;join('left join', 'm_jabatan', 'm_jabatan.id = k_jabatan.m_jabatan_id')
                -&gt;join('left join', 't_payroll_komponen', 't_payroll_det.id = t_payroll_komponen.t_payroll_det_id')
                -&gt;join('left join', 'm_komponen_gaji', 'm_komponen_gaji.id = t_payroll_komponen.m_komponen_gaji_id')
                -&gt;join('left join', 'm_perusahaan', 'm_perusahaan.id = karyawan.m_perusahaan_id')
                -&gt;join('left join', 'w_provinsi', 'w_provinsi.id = karyawan_data.w_provinsi_id')
                -&gt;join('left join', 'w_kota', 'w_kota.id = karyawan_data.w_kota_id')
                -&gt;join('left join', 'w_kecamatan', 'w_kecamatan.id = karyawan_data.w_kecamatan_id')
                -&gt;join('left join', 'w_desa', 'w_desa.id = karyawan_data.w_desa_id')
                -&gt;join('left join', 'm_bank', 'm_bank.id = karyawan.m_bank_id')
                -&gt;where('t_payroll_det.t_payroll_id', '=', $params['model']['id'])
                // -&gt;andWhere('t_payroll.m_perusahaan_id', '=', $idperusahaan)
                -&gt;andWhere('t_payroll.status', '=', 3)
            ;

            if (0 !== $params['karyawan_id'] &amp;&amp; !empty($params['karyawan_id'])) {
                $this-&gt;db-&gt;andWhere('karyawan.id', '=', $params['karyawan_id']);
            }
            $models = $this-&gt;db-&gt;findAll();

            $arr_data = [];
            foreach ($models as $key =&gt; $value) {
                $arr_data[$value-&gt;karyawan_id]['gaji_kode'] = $value-&gt;kode;
                $arr_data[$value-&gt;karyawan_id]['gaji_tgl_gaji'] = date('F, Y', strtotime($value-&gt;tgl_gaji));
                $arr_data[$value-&gt;karyawan_id]['gaji_periode_mulai'] = date('d F, Y', strtotime($value-&gt;periode_mulai));
                $arr_data[$value-&gt;karyawan_id]['gaji_periode_selesai'] = date('d F, Y', strtotime($value-&gt;periode_selesai));
                $arr_data[$value-&gt;karyawan_id]['gaji_keterangan'] = $value-&gt;keterangan;
                $arr_data[$value-&gt;karyawan_id]['perusahaan_nama'] = $value-&gt;nama_perusahaan;
                $arr_data[$value-&gt;karyawan_id]['perusahaan_alamat'] = $value-&gt;alamat_perusahaan;
                $arr_data[$value-&gt;karyawan_id]['perusahaan_telepon'] = $value-&gt;telepon_perusahaan;
                $arr_data[$value-&gt;karyawan_id]['karyawan_nik'] = $value-&gt;nik;
                $arr_data[$value-&gt;karyawan_id]['karyawan_nama'] = $value-&gt;nama_karyawan;
                $arr_data[$value-&gt;karyawan_id]['karyawan_alamat'] = $value-&gt;alamat_karyawan.', '.$value-&gt;provinsi.', '.$value-&gt;kota.', '.$value-&gt;kecamatan.', '.$value-&gt;desa.', '.$value-&gt;kode_pos;
                $arr_data[$value-&gt;karyawan_id]['karyawan_telepon'] = $value-&gt;no_hp_karyawan;
                $arr_data[$value-&gt;karyawan_id]['karyawan_email'] = $value-&gt;email;
                $arr_data[$value-&gt;karyawan_id]['karyawan_npwp'] = $value-&gt;no_npwp;
                $arr_data[$value-&gt;karyawan_id]['karyawan_jabatan'] = $value-&gt;nm_jabatan_karyawan;
                $arr_data[$value-&gt;karyawan_id]['nm_bank'] = $value-&gt;nm_bank;
                $arr_data[$value-&gt;karyawan_id]['no_rekening'] = $value-&gt;no_rekening;
                $arr_data[$value-&gt;karyawan_id]['nm_anbank'] = $value-&gt;nm_anbank;
                $arr_data[$value-&gt;karyawan_id]['kasbon'] = $value-&gt;kasbon;

                if (1 == $value-&gt;tipe) {
                    $arr_data[$value-&gt;karyawan_id]['pendapatan'][] = $value;
                }
                if (2 == $value-&gt;tipe) {
                    $arr_data[$value-&gt;karyawan_id]['potongan'][] = $value;
                }
                if (3 == $value-&gt;tipe) {
                    $arr_data[$value-&gt;karyawan_id]['pph'] = $value-&gt;nilai;
                }
            }
            // print_r($models);die;
            foreach ($arr_data as $key =&gt; $value) {
                // print_r($value);die;
                $sumdapat = 0;
                foreach ($value['pendapatan'] as $keys =&gt; $val) {
                    $val-&gt;nomor = $keys + 1;
                    $sumdapat += $val-&gt;nilai;
                    $arr_data[$key]['totaldapat'] = $sumdapat;
                }

                $sumpotong = 0;
                foreach ($value['potongan'] as $keys =&gt; $val) {
                    $val-&gt;nomor = $keys + 1;
                    $sumpotong += $val-&gt;nilai;
                    $arr_data[$key]['totalpotong'] = $sumpotong;

                    if (5 == $val-&gt;m_komponen_gaji_id) {
                        $arr_data[$key]['bayarkasbon'] = $val-&gt;nilai;
                    }
                }
            }
            foreach ($arr_data as $key =&gt; $value) {
                $arr_data[$key]['takehomepay'] = $value['totaldapat'] - $value['totalpotong'] - $value['pph'];
                $arr_data[$key]['sisakasbon'] = $value['kasbon'] - $value['bayarkasbon'];
            }
        }
        // print_r($arr_data);die;
        $arr = [];
        $i = 0;
        foreach ($arr_data as $keys =&gt; $value) {
            $arr[$i] = $value;
            ++$i;
        }
        // print_r($arr);die;
        return [
            'data' =&gt; $arr,
        ];
    }

    /**
     * Ambil semua data Slip Gaji.
     *
     * @param array  $params
     * @param int    $limit
     * @param int    $offset
     * @param string $order
     */
    public function getSlipgajiemail($params = [])
    {
        // print_r($params);die;
        $idperusahaan = $_SESSION['user']['m_perusahaan']['id'];
        $this-&gt;db-&gt;select('t_payroll.kode, t_payroll.tgl as tgl_gaji, t_payroll.periode_mulai, t_payroll.periode_selesai, t_payroll_det.*, t_payroll_det.karyawan_id as kid_payroll_det, t_payroll_komponen.*, m_komponen_gaji.nama, m_komponen_gaji.is_pokok, karyawan_data.nama as nama_karyawan, karyawan_data.id as idkaryawan, karyawan.nik, karyawan.m_bank_id, karyawan.no_rekening, karyawan.atas_nama as nm_anbank, m_bank.nama as nm_bank, karyawan_data.alamat_detail as alamat_karyawan, karyawan_data.kode_pos, karyawan_data.no_hp as no_hp_karyawan, karyawan_data.email, m_perusahaan.nama as nama_perusahaan, m_perusahaan.alamat as alamat_perusahaan, m_perusahaan.telepon as telepon_perusahaan, k_jabatan.m_jabatan_id, m_jabatan.nama as nm_jabatan_karyawan,w_provinsi.provinsi, w_kota.kota, w_kecamatan.kecamatan, w_desa.desa')
            -&gt;from('t_payroll')
            -&gt;join('left join', 't_payroll_det', 't_payroll_det.t_payroll_id = t_payroll.id')
            -&gt;join('left join', 'karyawan', 't_payroll_det.karyawan_id = karyawan.id')
            -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
            -&gt;join('left join', 'k_jabatan', 'k_jabatan.karyawan_id = karyawan_data.id')
            -&gt;join('left join', 'm_jabatan', 'm_jabatan.id = k_jabatan.m_jabatan_id')
            -&gt;join('left join', 't_payroll_komponen', 't_payroll_det.id = t_payroll_komponen.t_payroll_det_id')
            -&gt;join('left join', 'm_komponen_gaji', 'm_komponen_gaji.id = t_payroll_komponen.m_komponen_gaji_id')
            -&gt;join('left join', 'm_perusahaan', 'm_perusahaan.id = karyawan.m_perusahaan_id')
            -&gt;join('left join', 'w_provinsi', 'w_provinsi.id = karyawan_data.w_provinsi_id')
            -&gt;join('left join', 'w_kota', 'w_kota.id = karyawan_data.w_kota_id')
            -&gt;join('left join', 'w_kecamatan', 'w_kecamatan.id = karyawan_data.w_kecamatan_id')
            -&gt;join('left join', 'w_desa', 'w_desa.id = karyawan_data.w_desa_id')
            -&gt;join('left join', 'm_bank', 'm_bank.id = karyawan.m_bank_id')
            -&gt;where('t_payroll_det.t_payroll_id', '=', $params['model']['id'])
            -&gt;andWhere('t_payroll.m_perusahaan_id', '=', $idperusahaan)
            -&gt;andWhere('t_payroll.status', '=', 3)
        ;

        if (0 !== $params['karyawan_id'] &amp;&amp; !empty($params['karyawan_id'])) {
            $this-&gt;db-&gt;andWhere('karyawan.karyawan_data_id', '=', $params['karyawan_id']);
        }
        $models = $this-&gt;db-&gt;findAll();
        $arr_data = [];
        foreach ($models as $key =&gt; $value) {
            $arr_data[$value-&gt;karyawan_id]['gaji_kode'] = $value-&gt;kode;
            $arr_data[$value-&gt;karyawan_id]['gaji_tgl_gaji'] = date('d F, Y', strtotime($value-&gt;tgl_gaji));
            $arr_data[$value-&gt;karyawan_id]['gaji_periode_mulai'] = date('d F, Y', strtotime($value-&gt;periode_mulai));
            $arr_data[$value-&gt;karyawan_id]['gaji_periode_selesai'] = date('d F, Y', strtotime($value-&gt;periode_selesai));
            $arr_data[$value-&gt;karyawan_id]['gaji_keterangan'] = $value-&gt;keterangan;
            $arr_data[$value-&gt;karyawan_id]['perusahaan_nama'] = $value-&gt;nama_perusahaan;
            $arr_data[$value-&gt;karyawan_id]['perusahaan_alamat'] = $value-&gt;alamat_perusahaan;
            $arr_data[$value-&gt;karyawan_id]['perusahaan_telepon'] = $value-&gt;telepon_perusahaan;
            $arr_data[$value-&gt;karyawan_id]['karyawan_id'] = $value-&gt;idkaryawan;
            $arr_data[$value-&gt;karyawan_id]['karyawan_nik'] = $value-&gt;nik;
            $arr_data[$value-&gt;karyawan_id]['karyawan_nama'] = $value-&gt;nama_karyawan;
            $arr_data[$value-&gt;karyawan_id]['karyawan_alamat'] = $value-&gt;alamat_karyawan.', '.$value-&gt;provinsi.', '.$value-&gt;kota.', '.$value-&gt;kecamatan.', '.$value-&gt;desa.', '.$value-&gt;kode_pos;
            $arr_data[$value-&gt;karyawan_id]['karyawan_telepon'] = $value-&gt;no_hp_karyawan;
            $arr_data[$value-&gt;karyawan_id]['karyawan_email'] = $value-&gt;email;
            $arr_data[$value-&gt;karyawan_id]['karyawan_jabatan'] = $value-&gt;nm_jabatan_karyawan;
            $arr_data[$value-&gt;karyawan_id]['nm_bank'] = $value-&gt;nm_bank;
            $arr_data[$value-&gt;karyawan_id]['no_rekening'] = $value-&gt;no_rekening;
            $arr_data[$value-&gt;karyawan_id]['nm_anbank'] = $value-&gt;nm_anbank;
        }
        $arr = [];
        $i = 0;
        foreach ($arr_data as $keys =&gt; $value) {
            $arr[$i] = $value;
            ++$i;
        }

        return [
            'data' =&gt; $arr,
        ];
    }

    /**
     * Ambil semua data Karyawan.
     *
     * @param array  $params
     * @param int    $limit
     * @param int    $offset
     * @param string $order
     */
    public function getAllKaryawanNew($params = [], $limit = 0, $offset = 0, $order = '')
    {
        // print_r($params);die;
        $idkaryawanavailable = [];
        foreach ($params as $key =&gt; $value) {
            $idkaryawanavailable[] = $value['idkaryawan'];
        }
        $idkaryawantersedia = implode(',', $idkaryawanavailable);
        // print_r($idkaryawantersedia);die;
        $idperusahaan = $_SESSION['user']['m_perusahaan']['id'];
        $modelsP = $this-&gt;db-&gt;select('*')
            -&gt;from($this-&gt;table)
            -&gt;where('is_deleted', '=', 0)
            -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 0
            -&gt;andWhere('is_formula', '=', 0)
            -&gt;customWhere('m_perusahaan_id ='.$idperusahaan.' OR is_global = 1', 'AND')
            -&gt;andWhere('tipe', '=', 1) //tipe untuk isglobal 1
            -&gt;andWhere('is_deleted', '=', 0)
            -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
            -&gt;findAll()
        ;
        $modelsPt = $this-&gt;db-&gt;select('*')
            -&gt;from($this-&gt;table)
            -&gt;where('is_deleted', '=', 0)
            // -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
            -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 0
            -&gt;andWhere('is_formula', '=', 0)
            -&gt;customWhere('m_perusahaan_id ='.$idperusahaan.' OR is_global = 1', 'AND')
            -&gt;andWhere('tipe', '=', -1) //tipe untuk isglobal 1
            -&gt;andWhere('is_deleted', '=', 0)
            -&gt;customWhere('id NOT IN (2,3,6)', 'AND')
            -&gt;findAll()
        ;

        $karyawan = $this-&gt;db-&gt;select('karyawan.id as idkaryawan, karyawan.no_rekening, karyawan.atas_nama, m_bank.nama as nm_bank, karyawan_data.nama,karyawan.nik, karyawan.status_jht, karyawan.status_jp, karyawan.status_kesehatan, karyawan.status_pph, k_jabatan.m_jabatan_id, m_jabatan.nama as nm_jabatan, m_ptkp.nominal as nominal_ptkp')
            -&gt;from('karyawan')
            -&gt;join('left join', 'k_jabatan', 'k_jabatan.karyawan_id = karyawan.id AND k_jabatan.aktif = 1')
            -&gt;join('left join', 'm_jabatan', 'm_jabatan.id = k_jabatan.m_jabatan_id')
            -&gt;join('left join', 'karyawan_data', 'karyawan.karyawan_data_id = karyawan_data.id')
            -&gt;join('left join', 'm_ptkp', 'm_ptkp.id = karyawan_data.m_ptkp_id')
            -&gt;join('left join', 'm_bank', 'm_bank.id = karyawan.m_bank_id')
            -&gt;where('karyawan.status', '=', 1)
            -&gt;where('karyawan.m_perusahaan_id', '=', $idperusahaan)
            // -&gt;andWhere('karyawan.tipe_gaji', '=', $params['tipe'])
            -&gt;customWhere('karyawan.id NOT IN ('.$idkaryawantersedia.')', 'AND')
            -&gt;findAll()
        ;
        // print_r($karyawan);die;
        $modelsBpjs = [
            '0' =&gt; ['komponen_id' =&gt; '3', 'nama' =&gt; 'jk', 'nilai' =&gt; 0],
            '1' =&gt; ['komponen_id' =&gt; '3', 'nama' =&gt; 'jk_perusahaan', 'nilai' =&gt; 0],
            '2' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jkk_perusahaan', 'nilai' =&gt; 0],
            '3' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jkm_perusahaan', 'nilai' =&gt; 0],
            '4' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jht', 'nilai' =&gt; 0],
            '5' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jht_perusahaan', 'nilai' =&gt; 0],
            '6' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jp', 'nilai' =&gt; 0],
            '7' =&gt; ['komponen_id' =&gt; '2', 'nama' =&gt; 'jp_perusahaan', 'nilai' =&gt; 0],
        ];

        $bpjsperusahaan = $this-&gt;db-&gt;select('jkk as jkkperusahaan')
            -&gt;from('m_perusahaan')
            -&gt;where('id', '=', $_SESSION['user']['m_perusahaan']['id'])
            -&gt;find()
        ;

        // Ambil lembur karyawan
        $lembur = new Lembur();
        $mulai = isset($params['periode_mulai']) ? date('Y-m-d', strtotime($params['periode_mulai'])) : date('Y-m-d');
        $selesai = isset($params['periode_selesai']) ? date('Y-m-d', strtotime($params['periode_selesai'])) : date('Y-m-d');
        $arrLembur = $lembur-&gt;getLemburByPeriode($mulai, $selesai);

        // Ambil kasbon karyawan
        $kasbon = new Kasbon();
        $arrKasbon = $kasbon-&gt;getSisaKasbon();

        // print_r($bpjsperusahaan);die;
        $arr_data = [];
        $arr_karyawan = [];
        $arr_pendapatan = [];
        $arr_potongan = [];
        $arr_bpjs = [];

        foreach ($karyawan as $key =&gt; $value) {
            $value-&gt;jkkperusahaan = $bpjsperusahaan-&gt;jkkperusahaan;
            $value-&gt;keterangan = '';
            $value-&gt;totaldapat = 0;
            $value-&gt;jkkperusahaan = $bpjsperusahaan-&gt;jkkperusahaan;
            $value-&gt;totaldapat = 0;
            $value-&gt;totalpotong = 0;
            $value-&gt;totalbpjsketenagakerjaan = 0;
            $value-&gt;totalbpjsketenagakerjaan_perusahaan = 0;
            $value-&gt;totalbpjskesehatan = 0;
            $value-&gt;totalbpjskesehatan_perusahaan = 0;
            $value-&gt;pph = 0;
            $value-&gt;takehomepay = 0;
            $value-&gt;sumsemua = 0;
            $arr_karyawan[$key] = (array) $value;
            foreach ($modelsP as $keys =&gt; $vals) {
                if (isset($valz-&gt;nilai) &amp;&amp; '' == $vals-&gt;nilai) {
                    $vals-&gt;nilai = 0;
                } else {
                    $vals-&gt;nilai = 0;
                }
                $vals-&gt;nm_komponen = $vals-&gt;nama;
                $arr_karyawan[$key]['pendapatan'][$keys] = (array) $vals;
            }
            foreach ($modelsPt as $keyz =&gt; $valz) {
                if (isset($valz-&gt;nilai) &amp;&amp; '' == $valz-&gt;nilai) {
                    $valz-&gt;nilai = 0;
                } else {
                    $valz-&gt;nilai = 0;
                }
                $valz-&gt;nm_komponen = $valz-&gt;nama;
                $arr_karyawan[$key]['potongan'][$keyz] = (array) $valz;
            }
            foreach ($modelsBpjs as $keya =&gt; $vala) {
                if (isset($vala['nilai']) &amp;&amp; '' == $vala['nilai']) {
                    $vala['nilai'] = 0;
                } else {
                    $vala['nilai'] = 0;
                }
                $vala['nm_komponen'] = $vala['nama'];
                $arr_karyawan[$key]['bpjs'][$keya] = (array) $vala;
            }
        }
        foreach ($arr_karyawan as $key =&gt; $value) {
            $kasbon = isset($arrKasbon[$value['idkaryawan']]['kasbon']) ? $arrKasbon[$value['idkaryawan']]['kasbon'] : 0;
            $bayar = isset($arrKasbon[$value['idkaryawan']]['bayar']) ? $arrKasbon[$value['idkaryawan']]['bayar'] : 0;

            foreach ($value['pendapatan'] as $keys =&gt; $vals) {
                $cektkomponen = $this-&gt;db-&gt;select('*')
                    -&gt;from('t_komponen_gaji')
                    -&gt;where('karyawan_id', '=', $value['idkaryawan'])
                    -&gt;andWhere('m_komponen_id', '=', $vals['id'])
                    -&gt;find()
                ;
                if (isset($cektkomponen-&gt;karyawan_id) &amp;&amp; !empty($cektkomponen-&gt;karyawan_id)) {
                    $arr_karyawan[$key]['pendapatan'][$keys]['nilai'] = $cektkomponen-&gt;nominal;
                }
                // Ambil nilai lembur
                if (4 == $vals['id']) {
                    $arr_karyawan[$key]['pendapatan'][$keys]['nilai'] = isset($arrLembur[$value['idkaryawan']]) ? $arrLembur[$value['idkaryawan']] : 0;
                }
            }
            foreach ($value['potongan'] as $keyz =&gt; $valz) {
                $cektkomponen = $this-&gt;db-&gt;select('*')
                    -&gt;from('t_komponen_gaji')
                    -&gt;where('karyawan_id', '=', $value['idkaryawan'])
                    -&gt;andWhere('m_komponen_id', '=', $valz['id'])
                    -&gt;find()
                ;
                if (isset($cektkomponen-&gt;karyawan_id) &amp;&amp; !empty($cektkomponen-&gt;karyawan_id)) {
                    $arr_karyawan[$key]['potongan'][$keyz]['nilai'] = $cektkomponen-&gt;nominal;
                }
                // Ambil nilai kasbon
                if (5 == $valz['id'] &amp;&amp; $kasbon - $bayar &gt; 0) {
                    $arr_karyawan[$key]['potongan'][$keyz]['nilai'] = $kasbon - $bayar;
                }
            }
            $arr_karyawan[$key]['kasbon'] = ($kasbon - $bayar &gt; 0) ? $kasbon - $bayar : 0;
            $arr_karyawan[$key]['detailKasbon'] = isset($arrKasbon[$value['idkaryawan']]['detail']) ? $arrKasbon[$value['idkaryawan']]['detail'] : [];
        }
        // print_r($arr_karyawan);die;
        return [
            'data' =&gt; $arr_karyawan,
        ];
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>